<img src = "https://hohomi.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F74fe0ed3-0bc9-4bf8-84d6-2834b46b14b9%2FGroup_654.png?table=block&id=66df19d5-2623-4708-890e-c351cbe6fcd1&spaceId=e35bdae9-081e-4700-af54-3a3b789dd08a&width=250&userId=&cache=v2.jpg" width="200" height="200">

# 🙌 모이자!(Moyiza)

일일 모임부터 정기 모임까지!

누구나 열고 참여할 수 있는 취미 공유 플랫폼, 가볍고 즐겁게 만나보세요.

모두 여기, 모이자! 🙌

<https://mo2za.com>


![모이자썸네일](https://hohomi.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fb0217d60-40f3-4aa8-997c-d28ed8c3dc07%2FFrame_14.png?id=ba8b090e-789c-48be-a0ba-70ad0f8b7fae&table=block&spaceId=e35bdae9-081e-4700-af54-3a3b789dd08a&width=1340&userId=&cache=v2.png)

<br/>
<br/>
  
## ✔️ 프로젝트 기간
2023 / 05 / 19 ~ 06 / 30

<br/>

## ✔️ 주요 기능
<details>
<summary>소셜 로그인</summary>
<div markdown="1">       
  
  
- 회원가입 & 로그인이 번거롭다고 생각되는 유저를 위한 소셜로그인 기능
  

<img src = "https://hohomi.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F65871667-35ac-4786-bad0-1f08539ba3f9%2F%25E1%2584%2589%25E1%2585%25A9%25E1%2584%2589%25E1%2585%25A7%25E1%2586%25AF%25E1%2584%2585%25E1%2585%25A9%25E1%2584%2580%25E1%2585%25B3%25E1%2584%258B%25E1%2585%25B5%25E1%2586%25AB.png?id=c19d3771-1323-406a-9abd-335fcd87b20d&table=block&spaceId=e35bdae9-081e-4700-af54-3a3b789dd08a&width=1920&userId=&cache=v2.png">


</div>
</details>

<details>
<summary>일상속(정기모임)</summary>
<div markdown="1">       
  
  
- 취미가 비슷한 사람들과 함께 정기 모임을 가질 수 있는 일상속
  

<img src = "https://hohomi.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F7b0b43f7-433f-4b5c-a23a-e57ca40b5914%2F%25E1%2584%258B%25E1%2585%25B5%25E1%2586%25AF%25E1%2584%2589%25E1%2585%25A1%25E1%2586%25BC%25E1%2584%2589%25E1%2585%25A9%25E1%2586%25A8.png?id=d044afd4-0afd-42df-992e-3ca694424737&table=block&spaceId=e35bdae9-081e-4700-af54-3a3b789dd08a&width=1920&userId=&cache=v2.png">

<img src = "https://hohomi.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Ff845c40f-4080-4c64-bc04-f0da20dc2274%2F%25E1%2584%258B%25E1%2585%25B5%25E1%2586%25AF%25E1%2584%2589%25E1%2585%25A1%25E1%2586%25BC%25E1%2584%2589%25E1%2585%25A9%25E1%2586%25A8%25E1%2584%2589%25E1%2585%25A1%25E1%2586%25BC%25E1%2584%2589%25E1%2585%25A6.png?id=75efbb49-d4fd-4428-a9d3-7bfd8f02152f&table=block&spaceId=e35bdae9-081e-4700-af54-3a3b789dd08a&width=1920&userId=&cache=v2.png">


</div>
</details>

<details>
<summary>하루속(일일모임)</summary>
<div markdown="1">       
  
  
- 취미가 비슷한 사람들과 함께 일일 모임을 가질 수 있는 하루속
  
  

<img src = "https://hohomi.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fd050bfb3-e199-48bd-b1b2-6b7c23f4a960%2F%25E1%2584%2592%25E1%2585%25A1%25E1%2584%2585%25E1%2585%25AE%25E1%2584%2589%25E1%2585%25A9%25E1%2586%25A8.png?id=892372f0-b650-41c6-980c-6330c6d5595c&table=block&spaceId=e35bdae9-081e-4700-af54-3a3b789dd08a&width=1920&userId=&cache=v2.png">

<img src = "https://hohomi.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fa507392d-130c-4901-857c-ab97d5fc4bf0%2F%25E1%2584%2592%25E1%2585%25A1%25E1%2584%2585%25E1%2585%25AE%25E1%2584%2589%25E1%2585%25A9%25E1%2586%25A8%25E1%2584%2589%25E1%2585%25A1%25E1%2586%25BC%25E1%2584%2589%25E1%2585%25A6.png?id=35feffdb-25d2-4007-86d4-49148c796edc&table=block&spaceId=e35bdae9-081e-4700-af54-3a3b789dd08a&width=1920&userId=&cache=v2.png">


</div>
</details>

<details>
<summary>게시글 임시 저장</summary>
<div markdown="1">       
  
  
- 모임을 개설할 때에 설정해야 하는 항목이 많아, 모임을 개설하다가 페이지를 이탈하더라도 임시저장이 되는 기능
  
  

<img src = "https://hohomi.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F522653bf-2241-4d54-bf92-330634bdbc74%2F%25E1%2584%258B%25E1%2585%25B5%25E1%2586%25B7%25E1%2584%2589%25E1%2585%25B5%25E1%2584%258C%25E1%2585%25A5%25E1%2584%258C%25E1%2585%25A1%25E1%2586%25BC.png?id=1a0ba165-67a4-4308-a9b5-41de4717c738&table=block&spaceId=e35bdae9-081e-4700-af54-3a3b789dd08a&width=1920&userId=&cache=v2.png">


</div>
</details>

<details>
<summary>실시간 채팅</summary>
<div markdown="1">       
  
  
- 일상속, 하루속을 가입하면 생기는 채팅기능. 모임을 갖기 전, 모임에 있는 사람들과 소통할 수 있는 방법
  
  

<img src = "https://hohomi.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F1b3cd6cd-2377-40de-9965-252eade6bdc6%2F%25E1%2584%2586%25E1%2585%25A9%25E1%2584%258B%25E1%2585%25B5%25E1%2586%25B7_%25E1%2584%2580%25E1%2585%25A1%25E1%2584%258B%25E1%2585%25B5%25E1%2586%25B8.png?id=47ff1b98-9539-4d36-a408-51ac6ce6ab7a&table=block&spaceId=e35bdae9-081e-4700-af54-3a3b789dd08a&width=1920&userId=&cache=v2.png">

<img src = "https://hohomi.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fc61c2661-34b7-453b-a6a2-a438baab266e%2F%25E1%2584%258E%25E1%2585%25A2%25E1%2584%2590%25E1%2585%25B5%25E1%2586%25BC%25E1%2584%2587%25E1%2585%25A1%25E1%2586%25BC.png?id=3ede46bf-e0d5-41b6-8929-7b4cf32f2823&table=block&spaceId=e35bdae9-081e-4700-af54-3a3b789dd08a&width=1350&userId=&cache=v2.png">

<img src = "https://hohomi.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F5a25cb98-d397-4502-8474-56a1f2872373%2F%25E1%2584%258E%25E1%2585%25A2%25E1%2584%2590%25E1%2585%25B5%25E1%2586%25BC%25E1%2584%2587%25E1%2585%25A1%25E1%2586%25BC2.png?id=e36bae13-9fb4-4324-8a86-158e6f1b3ef4&table=block&spaceId=e35bdae9-081e-4700-af54-3a3b789dd08a&width=1920&userId=&cache=v2.png">

<img src = "https://hohomi.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fe4eb51f5-8e5f-4ff1-ac34-f791333370e7%2F%25E1%2584%258E%25E1%2585%25A2%25E1%2584%2590%25E1%2585%25B5%25E1%2586%25BC%25E1%2584%2587%25E1%2585%25A1%25E1%2586%25BC3.png?id=3b825606-6dcd-467d-a258-6181d18a00e4&table=block&spaceId=e35bdae9-081e-4700-af54-3a3b789dd08a&width=1920&userId=&cache=v2.png">


</div>
</details>

<details>
<summary>마이페이지</summary>
<div markdown="1">       
  
  
- 내가 운영중, 참여중인 모임을 관리할 수 있는 마이페이지
  

<img src = "https://hohomi.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fe913f081-8672-495b-a086-c1233a78efba%2F%25E1%2584%2589%25E1%2585%25B3%25E1%2584%258F%25E1%2585%25B3%25E1%2584%2585%25E1%2585%25B5%25E1%2586%25AB%25E1%2584%2589%25E1%2585%25A3%25E1%2586%25BA_2023-06-29_%25E1%2584%258B%25E1%2585%25A9%25E1%2584%2592%25E1%2585%25AE_1.18.34.png?id=6b2a316b-1c95-483e-8c4f-2dadada3512d&table=block&spaceId=e35bdae9-081e-4700-af54-3a3b789dd08a&width=1920&userId=&cache=v2.png">


</div>
</details>

<details>
<summary>위치 기반 모임 추천</summary>
<div markdown="1">       
  
  
- 내 위치를 중심으로 가까운 곳에서 진행되는 모임 보기
  
  

<img src = "https://hohomi.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F28da5c3e-2991-45fd-8fec-f526373cd7fe%2F%25E1%2584%258B%25E1%2585%25B1%25E1%2584%258E%25E1%2585%25B5%25E1%2584%2580%25E1%2585%25B5%25E1%2584%2587%25E1%2585%25A1%25E1%2586%25AB.png?id=9686b44f-1f33-4f07-8155-f3886f64a16b&table=block&spaceId=e35bdae9-081e-4700-af54-3a3b789dd08a&width=1920&userId=&cache=v2.png">


</div>
</details>

<br/>


## ✔️ 기술 아키텍쳐
<img src = "https://hohomi.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F1442a192-6fd6-486f-8685-9739bb8a0a01%2Farchitecture.jpg?id=ea3790c9-6496-464c-aec3-9a998044ee4a&table=block&spaceId=e35bdae9-081e-4700-af54-3a3b789dd08a&width=1920&userId=&cache=v2.jpg">


<br/>

  
## ✔️ 기술적 의사 결정
|**선택 기술**|선택 이유 및 근거|
|:---:|---|
|Redis|- 웹소켓 세션 저장소 및 채팅로직 구현을 위한 저장소로 활용 </br> ⇒ key-value 저장소로서 빠르고, sorted set 등 유용한 자료구조 제공 </br> - 이메일,SMS 인증을 위한 임시저장소로 활용 </br> - 조회가 잦은 데이터(인기모임, 최근채팅 등)를 위한 캐시로 활용 </br> ⇒ 조회가 빠르고, DB삽입을 줄여 block 되는 시간을 줄이기 위함 </br> - 인기모임 로직 구현을 위한 ranking 저장소로 활용 ⇒ lifetime을 주어 주기적으로 갱신 가능 / sorted set의 유용함|
|Websocket / STOMP|- pub/sub 구조의 채팅 기능에서 구독 기능과 메시지 broadcasting을 간편하게구현할 수 있음|
|Apache Kafka|- 메시지 브로커로서 활용, 트래픽에 대비하고 수평적 확장성을 고려 </br> ⇒고성능,고가용성 // 메시지가 휘발성이 아니기 때문에 채팅기록을 db에 batch로 업데이트할 수 있다. Streams API 등 강력한 기능을 제공 </br> - 알림 기능을 위한 event 브로커로서 활용|
|QueryDSL|- 모임 검색 기능의 다양한 검색 요구조건에 대응하기 위해 사용 </br> ⇒ 검색어, 카테고리 필터 및 다양한 태그를 조건으로 dynamic Query를 구현하기에 좋다|
|Spring batch|- 대량의 데이터 처리 및 배치 작업을 수행 </br> 논리적 삭제 처리된 데이터를 정해진 주기마다 일괄처리하기 위해 사용|
|ServerSentEvent(SSE)|- 채팅과 달리 참석자의 참석 여부를 알려주는 알림이 필요했음 </br> - 클라이언트가 일정한 주기로 서버에 업데이트 요청을 보내는 방법은 지속적인 요청을 보내야하므로 리소스 낭비가 심할 것 같았음 </br> - 실시간 양방향 통신을 위한 스펙으로 서버와 브라우저가 지속적으로 연결된 TCP라인을 통해 실시간으로 데이터를 주고받을 수 있도록 하는 websocket은 서버에서 클라이언트 방향으로만 데이터를 보내면 되기 때문에 필요없었음 </br> - 따라서 웹 소켓에 비해 가볍고 서버 -> 클라이언트 방향을 지원하는 SSE를 선택|
|AWS 로드밸런서 (ALB)|- 병렬적으로 구성된 서버에 요청을 분산해주기 위함 </br> ⇒ 간단하게 구성이 가능하다|
|AWS CloudWatch-agent|- 서버 자원(특히 메모리)을 모니터링 하기 위함|
|Github Actions|- 빌드 및 배포 자동화를 위해 사용 </br> ⇒ 비교적 간단하게 사용 가능하고, 접근성이 좋음|

|Spring Actuator|- metric 노출|
|Prometheus|- metric 수집|
|Grafana|- metric 시각화 (APM 대시보드)|

|Junit|- 단위 테스트 위해 사용|
|JMeter|- API 및 웹소켓에 대한 부하테스트 툴로 활용 </br> ⇒ 접근성 및 웹소켓 지원|

<br/>

    
## ✔️ 트러블 슈팅

<details>
<summary>CI/CD 중 CodeDeploy 환경변수 설정 이슈</summary>
<div markdown="1">       

- 문제내용
    - Git Action에서 `Input required and not supplied: aws-region` ← 이 에러가 떠서 AWS 관련 계정의 region을 전부 통일하고 deploy script에서 region을 잘 맞춰주었는데도 같은 에러가 발생
    - region 에러 메시지만으로는 정확한 원인을 파악하기가 어려워 deploy script log가 찍히는 경로를 찾아 확인해보니 jar 파일이 CodeDeploy를 통해 재실행될 때 Jasypt Password를 찾을 수 없다는 에러가 뜨는 것을 발견
- 해결코드
    
    ```java
    /.bash_profile
    export JASYPT_PASSWORD=패스워드
    
    /Code Deploy script
    source $HOME/.bash_profile
    ```
    
- 해결방법
    - 시도한 방법
        - Jasypt 라이브러리 환경변수를 Ubuntu에 영구 설정했으나 같은 에러 발생
        - Jasypt 라이브러리 환경변수를 Git Secret에 등록한 뒤 deploy script에 반영했으나 같은 에러 발생
    - 해결한 방법
        - Ubuntu에서 숨겨져 있던 .bash_profile을 찾아 거기에 JASYPT_PASSWORD를 export로 등록함 ⇒ `export JASYPT_PASSWORD=패스워드`
        - 그 다음 CodeDeploy가 실행시키는 스크립트에 source 명령어로 .bash_profile을 로드하여 참조할 수 있게 함 ⇒ `source $HOME/.bash_profile`
</div>
</details>

<details>
<summary>Spring Security</summary>
<div markdown="1">       

- 문제내용
    - Spring Security를 사용하여 사용자 권한 설정 문제
        - Social Login을 구현하는 과정에서 비즈니스 전환(사업자 등록)을 하지 못해 (이메일, 프로필사진 등) 제한적인 정보만 받아올 수 있었다. 따라서, 첫 소셜 회원가입 사용자 Role을 'Guest'로 설정하였고, 사용자가 추가 정보를 입력하면 'User' Role로 업데이트 시키는 방식으로 구현하였다.
        이 경우, 추가 정보를 제공하지 않은 'Guest' 사용자에 대한 접근 권한 제어가 필요했는데 이때, 접근 권한 설정을 해주어도 접근을 막지 못 한 문제 발생
        
- 해결코드
    
    ```java
    http.cors().and()
                    //...
                    .anyRequest().hasAnyAuthority("ROLE_USER", "ROLE_ADMIN").and()
                    .exceptionHandling().accessDeniedHandler(customAccessDeniedHandler).and()
                    .oauth2Login()
                    .successHandler(oAuth2LoginSuccessHandler)
                    .failureHandler(oAuth2LoginFailureHandler)
                    .userInfoEndpoint().userService(customOAuth2UserService);
            http.addFilterBefore(jwtAuthFilter, UsernamePasswordAuthenticationFilter.class);
    ```
    
- 해결방법
    - 시도한 방법
        - 'Guest' Role을 가진 사용자에게 'ROLE_ANONYMOUS' 권한을 부여하고,
        .anyRequest().authenticated() 로 접근을 제한했으나 'ROLE_ANONYMOUS' 권한을 가진 사용자에게도 접근을 허용했다.
            - .authenticated()는 ‘인증된’ 사용자를 모두 포함한다. 즉, 사용자가 유효한 자격증명(ex: 토큰, 아이디+비밀번호)을 가졌는지 확인한다. 이때 사용자의 Role은 고려하지 않는다.
            따라서, 소셜 로그인 성공 후, Access Token을 발급받은 사용자에게 ‘ROLE_ANONYMOUS’가 할당 되어있어도 접근은 막을 수 없었다.
    - 해결한 방법
        - **.authenticated()** 대신 **.hasAnyAuthority("ROLE_USER", "ROLE_ADMIN")** 메소드를 사용하여 'Guest' Role의 사용자에 대한 접근을 제한하였다. 예상한 대로 'Guest' 사용자의 접근을 성공적으로 제한할 수 있었다.
        추가적으로, **CustomAccessDeniedHandler**를 사용하여 Role이 ‘GUEST’인 사용자와 비로그인 사용자를 구분, 특정 메시지를 반환하도록 하였다.
</div>
</details>

<details>
<summary>영속성 컨텍스트 변경 감지</summary>
<div markdown="1">       

- 문제내용
    - @LastModifiedDate 애노테이션이 적용된 "ModifiedAt" 필드가 자동으로 업데이트 되지 않는 문제
        - @Modifying @Quary를 사용하여 ‘isDeleted’ 필드를 직접 업데이트 하는 쿼리를 실행했으나, ModifiedAt 필드가 업데이트 되지 않는 문제 발생
- 해결코드
    
    ```java
    User user = userRepository.findById(userId).get();
    user.setIsDeleted(true);
    ```
    
- 해결방법
    - 시도한 방법
        1. User Entity에 “ModifiedAt” 필드 추가
            - 간단하게 User Entity에 “ModifiedAt”필드를 추가하는 것을 고려했으나, User는 이미 "TimeStamped" 상위 클래스를 상속받아 @LastModifiedDate 어노테이션이 적용된 "ModifiedAt" 필드가 정의되어 있었습니다. 따라서, User Entity에 다시 "ModifiedAt" 필드를 추가하는 것은 중복되는 코드를 작성하는 것이므로 비효율적이라 판단하였습니다.
        2. @Transactional 어노테이션 추가
            - @Modifying과 함께 @Transactional 어노테이션을 추가해서 트랜잭션 범위 내에 포함시켜, JPA 영속성 컨텍스트에서 Entity의 상태 변화 감지를 기대했지만 동작하지 않았습니다.
    - 해결한 방법
        - User Entity 직접 조회 및 변경
            - User Repository에서 findById로 직접 조회 후 변경하니 JPA에서 변경을 감지할 수 있었고 “ModifiedAt”필드가 정상적으로 업데이트 되었습니다.
                - JPA의 영속성 컨텍스트와 변경 감지(Dirty Checking)를 활용하여 @LastModifiedDate를 정삭적으로 동작할 수 있게 하였습니다.
</div>
</details>

<details>
<summary>채팅관련</summary>
<div markdown="1">       

- 문제내용 : 채팅 안읽은 Count를 메시지의 속성으로 관리할 경우 채팅에 참여한 N명의 유저가 해당 속성을 업데이트 하려고 하여 병목이 발생 + 읽었다는 signal 문제
    - 해결 코드 :
        
        ```java
        public Long getTotalReadCount(String chatId, Long nowMessageId) {
                return getInactiveReadCount(chatId, nowMessageId) + countSubscriptionToChatId(chatId);
            }
        ```
        
    - 해결한 방법 : count 계산로직 구현 https://imslo.tistory.com/80

- 문제내용 : **채팅 안읽은 count가 음수 되는 현상**  https://github.com/H99-FinalProj-Moyiza/Moyiza_BE/issues/329
    - 해결한 방법 : STOMP connect 요청 시 토큰과 session 재검증

- 문제내용 : Kafka 클러스터 구축시 각종 config 문제, 포트문제 등
    - 해결한 방법 : 레퍼런스 참조, 반복작업 및 실험 …
    - 참조 레퍼런스 :
        
        https://zookeeper.apache.org/doc/r3.4.8/zookeeperAdmin.html
        
        https://medium.com/geekculture/create-your-apache-kafka-cluster-in-30-minutes-872dab6e93c0
        
        https://blog.voidmainvoid.net/325
        
- 문제내용 : 윈도우 환경에서 kafka 테스트 시 윈도우 WSL2 로컬호스트 relay 이슈 : WSL2에서 돌고있는 kafka를 Spring에 연결할 수 없는 문제
    - 알려진 issue : https://github.com/microsoft/WSL/issues/4851
    - 해결 방법 : https://stackoverflow.com/questions/71569699/running-kafka-confluent-platform-on-wsl-2-ubuntu-distribution-and-spring-appli
    - 해결 코드 :
        
        ```bash
        ifconfig #ip 적어두기
        #윈도우 터미널
        netsh interface portproxy add v4tov4 listenport=9092 listenaddress=0.0.0.0 connectport=9092 connectaddress=172.xx.xx.xx
        ```
        

- 문제 내용 :  CPU와 메모리가 남았음에도 STOMP connection이 370개 이상 생기지 않는 이유
    - 시도한 방법 : -Xmx512m 옵션으로 로컬에서 문제상황 재현하기 시도 , ubuntu file descriptor limit 수정, threaddump 분석, redis/DB 병목 확인 …etc
    - 해결 방법 : 아직 정확한 원인을 찾지는 못했다. Kafka를 도입하면서 서버를 증설하여 전체 수용가능 connection은 늘었으니, 원인을 다시 찾아볼 예정
</div>
</details>
 
<br/>


## ✔️ 팀원 소개
|**이름**|주특기|Github|
|:---:|:---:|:---:|
|홍종훈|React|https://github.com/whdgnszz1|
|정해진|React|https://github.com/HaeJinS2|
|김민정|React|https://github.com/minnjeong|
|김덕인|Spring|https://github.com/Dunkin00|
|강재형|Spring|https://github.com/mottoslo|
|이호정|Spring|https://github.com/Hohomii|
|강동현|Spring|https://github.com/kangdh208|

